name: Metrics
on:
  schedule: [{ cron: "0 0 * * *" }]
  workflow_dispatch:
  push: { branches: ["master", "main"] }

jobs:
  # ============================================
  # JOB 1: MÃ‰TRICAS GENERALES
  # ============================================
  general-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Generate General Metrics
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          committer_token: ${{ secrets.METRICS_TOKEN }}

          filename: github-metrics.svg
          committer_branch: master
          committer_message: "chore: update github metrics [skip ci]"

          user: johpaz
          template: classic
          config_timezone: America/Bogota

          base: header, activity, community, repositories, metadata
          repositories_affiliations: owner
          repositories_forks: no

          plugin_isocalendar: yes
          plugin_isocalendar_duration: half-year

          plugin_lines: yes
          plugin_lines_sections: base

          plugin_traffic: no
          plugin_languages: no

          plugin_achievements: no
          plugin_habits: no
          plugin_activity: no
          plugin_notable: no

  # ============================================
  # JOB 2: LENGUAJES (espera a que termine job 1)
  # ============================================
  languages-chart:
    runs-on: ubuntu-latest
    needs: general-metrics
    permissions:
      contents: write
    steps:
      - name: Generate Languages Chart
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          committer_token: ${{ secrets.METRICS_TOKEN }}

          filename: languages.svg
          committer_branch: master
          committer_message: "chore: update languages chart [skip ci]"

          user: johpaz
          base: ""

          plugin_languages: yes
          plugin_languages_ignored: html, css, scss, tex
          plugin_languages_limit: 12
          plugin_languages_threshold: 0%
          plugin_languages_sections: most-used
          plugin_languages_details: bytes-size, percentage, lines
          plugin_languages_colors: rainbow
          plugin_languages_indepth: yes
          plugin_languages_analysis_timeout: 30
          plugin_languages_categories: markup, programming, data

  # ============================================
  # JOB 3: SNAKE (espera a que termine job 2)
  # ============================================
  snake-animation:
    runs-on: ubuntu-latest
    needs: languages-chart
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: master
          fetch-depth: 0

      - name: Generate Snake Animation
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: johpaz
          outputs: |
            github-contribution-grid-snake.svg
            github-contribution-grid-snake-dark.svg?palette=github-dark
        env:
          GITHUB_TOKEN: ${{ secrets.METRICS_TOKEN }}

      - name: Commit Snake
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add github-contribution-grid-snake*.svg

          if ! git diff --quiet HEAD || ! git diff --staged --quiet; then
            git commit -m "chore: update snake animation [skip ci]"
            git push origin master
          fi
